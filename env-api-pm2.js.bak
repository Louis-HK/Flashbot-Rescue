// env-api-pm2.js simplifié avec login/password
const express = require('express');
const fs = require('fs');
const bodyParser = require('body-parser');
const { exec } = require('child_process');

// Charger le .env
const ENV_PATH = '/opt/flashbot-rescue/.env';
require('dotenv').config({ path: ENV_PATH });

const app = express();
const PORT = 4001;
const BOT_NAME = 'flashbot-rescue';

// Credentials simples
const USERNAME = 'admin';
const PASSWORD = 'motdepasse';

app.use(bodyParser.json());

// Middleware Auth basique
app.use((req, res, next) => {
    const auth = req.headers['authorization'];
    if (!auth || !auth.startsWith('Basic ')) {
        res.set('WWW-Authenticate', 'Basic realm="Env API"');
        return res.status(401).send('Unauthorized');
    }

    const credentials = Buffer.from(auth.split(' ')[1], 'base64').toString().split(':');
    const [user, pass] = credentials;

    if (user !== USERNAME || pass !== PASSWORD) {
        res.set('WWW-Authenticate', 'Basic realm="Env API"');
        return res.status(401).send('Unauthorized');
    }

    next();
});

// Endpoint GET /env
app.get('/env', (req, res) => {
    if (!fs.existsSync(ENV_PATH)) {
        return res.status(404).json({ error: '.env file not found' });
    }

    const envContent = fs.readFileSync(ENV_PATH, 'utf8');
    const envVars = {};
    envContent.split('\n').forEach(line => {
        if (line.trim() && line.includes('=')) {
            const [key, value] = line.split('=');
            envVars[key] = value.replace(/(^"|"$)/g, '');
        }
    });

    res.json(envVars);
});

// Endpoint POST /update-env
app.post('/update-env', (req, res) => {
    const envData = req.body;
    if (!envData || typeof envData !== 'object') {
        return res.status(400).json({ error: 'Invalid request body' });
    }

    // Backup .env
    const backupPath = `${ENV_PATH}.bak_${Date.now()}`;
    fs.copyFileSync(ENV_PATH, backupPath);

    // Ecriture du nouveau .env
    let envContent = '';
    for (const [key, value] of Object.entries(envData)) {
        envContent += `${key}="${value}"\n`;
    }

    fs.writeFile(ENV_PATH, envContent, 'utf8', (err) => {
        if (err) return res.status(500).json({ error: 'Failed to write .env' });

        // Redémarrage du bot
        exec(`pm2 restart ${BOT_NAME}`, (err) => {
            if (err) return res.status(500).json({ error: 'Env updated but failed to restart bot' });

            return res.json({
                success: true,
                message: '.env updated and bot restarted',
                backup: backupPath
            });
        });
    });
});

// Formulaire HTML
app.get('/', (req, res) => {
    res.send(`
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Flashbot .env Update</title>
</head>
<body>
<h2>Update Flashbot .env</h2>
<form id="envForm">
<label>PRIVATE_KEY: <input type="text" name="PRIVATE_KEY"></label><br>
<label>FUNDER_WALLET_PK: <input type="text" name="FUNDER_WALLET_PK"></label><br>
<label>RPC_URL: <input type="text" name="RPC_URL" value="http://127.0.0.1:8545"></label><br>
<label>SAFE_ADDRESS: <input type="text" name="SAFE_ADDRESS" value="0x91a7c0acef1fC528CE695513A648490C8242191A"></label><br>
<label>TOKEN_ADDRESS: <input type="text" name="TOKEN_ADDRESS" value="0xdAC17F958D2ee523a2206206994597C13D831ec7"></label><br>
<label>CHAIN_ID: <input type="text" name="CHAIN_ID" value="1"></label><br>
<button type="submit">Update .env</button>
</form>

<script>
document.getElementById('envForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());

    const username = prompt("Login:");
    const password = prompt("Password:");
    const token = btoa(username + ':' + password);

    const res = await fetch('/update-env', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Basic ' + token
        },
        body: JSON.stringify(data)
    });
    const result = await res.json();
    alert(JSON.stringify(result));
});
</script>

</body>
</html>
    `);
});

app.listen(PORT, '0.0.0.0', () => {
    console.log(`Env update API running on all interfaces (public)`);
});

